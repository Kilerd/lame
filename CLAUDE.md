# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

LAME (LAME Ain't an MP3 Encoder) is a high-quality MP3 encoding library and command-line tool. This is the SVN trunk version (r6531). The project is written in C and supports multiple platforms (Unix/Linux, Windows, macOS).

## Build System

### Unix/Linux/macOS (Standard Build)
```bash
./configure --disable-decoder --disable-analyzer-hooks
make
make install
```

**Note:** There is a known compilation issue with deprecated UCS2 functions in `frontend/parse.c`. This has been fixed by replacing `id3tag_set_comment_ucs2` with `id3tag_set_comment_utf16` and `id3tag_set_fieldvalue_ucs2` with `id3tag_set_fieldvalue_utf16` in line 417 and 420.

Common configure options:
- `--disable-decoder` - Exclude mpg123 MP3 decoder (recommended for encode-only usage)
- `--disable-analyzer-hooks` - Exclude analyzer hooks (reduces library size)
- `--enable-debug` - Build debug version
- `--enable-mp3x` - Build GTK+ MP3 frame analyzer
- `--enable-mp3rtp` - Build RTP streaming encoder
- `--enable-expopt` - Enable aggressive compiler optimizations
- `--prefix=PATH` - Set installation prefix (default: /usr/local)
- `--with-fileio=sndfile` - Use libsndfile for extended input format support

### Unix without Configure
```bash
make -f Makefile.unix
```

### Windows (MSVC)
```bash
copy configMS.h config.h
nmake -f Makefile.MSVC comp=msvc asm=no
```

## Architecture Overview

### Core Encoding Pipeline

The encoding flow is orchestrated through these key stages (see `frontend/main.c` and API file):

1. **`lame_init()`** - Initialize encoder (in `libmp3lame/lame.c`)
2. **`lame_init_params()`** - Configure encoder parameters based on settings
3. **`lame_encode_buffer()`** - Main encoding loop
   - Handles buffering and resampling
   - Calls `lame_encode_frame()` for each frame
4. **`lame_encode_frame_mp3()`** - Per-frame encoding:
   - `l3psycho_anal()` - Compute psychoacoustic masking thresholds
   - `mdct_sub()` - Compute MDCT coefficients
   - `iteration_loop()` - Choose scalefactors and Huffman tables
   - `format_bitstream()` - Format output bitstream
   - `copy_buffer()` - Copy to user's MP3 buffer
5. **`lame_encode_flush()`** - Flush remaining buffers
6. **`lame_mp3_tags_fid()`** - Write Xing VBR/INFO tag
7. **`lame_close()`** - Free resources

### Directory Structure

- **`libmp3lame/`** - Core encoding library (the heart of LAME)
  - Main encoding algorithms, psychoacoustic model, quantization, bitstream formatting
  - Key files: `lame.c`, `encoder.c`, `psymodel.c`, `quantize.c`, `bitstream.c`
  - Produces `libmp3lame.a` (static) and `libmp3lame.so` (shared)
  - `i386/` - x86 assembly optimizations (MMX, SSE)
  - `vector/` - SIMD/vector optimizations

- **`frontend/`** - Command-line interface and tools
  - `main.c` - Main command-line encoder entry point (good API usage example)
  - `parse.c` - Command-line argument parsing
  - `get_audio.c` - Audio file input handling
  - `mp3x.c` - GTK+ frame analyzer for debugging
  - `mp3rtp.c` - RTP streaming encoder

- **`mpglib/`** - MP3 decoding library (based on mpg123)
  - Used for MP3 input decoding and analysis features

- **`include/`** - Public API headers
  - `lame.h` - Main public API (FROZEN - don't modify)

- **`test/`** - Testing infrastructure
  - `lametest.py` - Python script for regression testing
  - Various `.op` files - Option presets for testing

- **`Dll/`** - Windows DLL wrapper
- **`ACM/`** - Windows ACM codec (deprecated)
- **`dshow/`** - DirectShow filter
- **`vc_solution/`** - Visual Studio project files
- **`doc/`** - Documentation (HTML and man pages)
- **`misc/`** - Utility scripts

## Key Configuration Files

- **`config.h`** - Compile-time configuration (auto-generated by configure, or copy `configMS.h` on Windows)
- **`configMS.h`** - Windows-specific configuration template
- **Compile-time options:**
  - `HAVE_MPGLIB` - Enable MP3 decoding capability
  - `HAVE_VORBIS` - Enable Vorbis decoding
  - `NOANALYSIS` - Disable frame analyzer hooks
  - `LIBSNDFILE` - Use libsndfile for extended input formats

## Testing

### Using the Python test script:
```bash
cd test
./lametest.py [-w] CBRABR.op your_audio.wav lame_original lame_modified
```

The `-w` flag converts MP3s to WAVs before comparison. Test files should be short to keep test runs fast.

## Code Style (from STYLEGUIDE)

- **Indentation:** Respect original author's indentation (use 4 spaces if inconsistent)
- **No tabs:** Use spaces only (tabs are mixed width in this codebase)
- **Integer types:** Use `int` for all integers (LAME requires 32-bit ints). Avoid `long`, `unsigned`, `char` for storage. Use `int64` for 64-bit.
- **Float types:** Use `FLOAT` (≥32-bit) or `FLOAT8` (≥64-bit) from `machine.h`, not raw `float`/`double`
- **PCM samples:** Type `sample_t` (currently a FLOAT)
- **Braces:** K&R style - opening brace on same line for control structures, new line for functions
- **Units:** Use SI base units (Hz, not kHz; bps, not kbps) internally
- **Assertions:** Use `assert()` for important assumptions

## Adding New Options

To add a new encoder option (from HACKING):

1. Add control variable to `lame_global_flags` struct
2. Implement getter/setter in `libmp3lame/set_get.c`:
   - `lame_set_new_variable()`
   - `lame_get_new_variable()`
3. Add command-line option parsing in `frontend/parse.c`
4. Document in `USAGE` file and `lame --longhelp` output

**Note:** Experimental features that shouldn't be in the public API go in the special section at the end of `set_get.c` and should NOT be prototyped in `lame.h`.

## Thread Safety

LAME is designed to be thread-safe and re-entrant. The main issue is that some OS threading implementations allocate small stacks (<128KB) which may be insufficient for LAME's automatic variables.

## Global State Management

Two types of global state structures (both initialized to zero):

1. **`lame_global_flags *gfp`** - Input parameters and public state
   - Instantiated by `lame_init()`
   - Contains user-settable parameters and public information

2. **`lame_internal_flags *gfc`** - Internal state
   - All internal data not set by user
   - Defined in `util.h`
   - Memory allocated in `lame_init_params()`, freed in `freegfc()`

## Important Notes

- **API is FROZEN:** The LAME public API in `include/lame.h` is frozen for stability. Don't modify it.
- **Platform support:** Unix/Linux, macOS, Windows (MSVC, MinGW, Cygwin), DOS (DJGPP)
- **Optimizations:** NASM assembly support for x86 MMX/SSE if detected by configure
- **Debugging:** Use `mp3x` (GTK+ frame analyzer) for studying MP3 frames - enable with `--enable-mp3x`
